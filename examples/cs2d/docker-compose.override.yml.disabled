# Docker Compose Override for Development
# This file is automatically loaded by docker-compose in development
version: '3.8'

services:
  redis:
    ports:
      - "6379:6379"
    volumes:
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server --appendonly yes --loglevel debug

  lively-app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    environment:
      - RACK_ENV=development
      - LIVELY_ENV=development
      - BUNDLE_PATH=/usr/local/bundle
      - RUBYOPT=-W0  # Suppress warnings in development
    volumes:
      # Mount entire project for hot reload
      - .:/app
      - bundle-cache:/usr/local/bundle
      - node-modules:/app/node_modules
    ports:
      - "9292:9292"
      - "9229:9229"  # Ruby debugger port
    stdin_open: true
    tty: true
    command: >
      bash -c "
        bundle install &&
        bundle exec lively ./application --reload
      "

  static-server:
    environment:
      - LOG_LEVEL=debug
    volumes:
      # Live reload for static files
      - ./public:/app/public
      - ./static_pages:/app/static_pages
      - ./static_server.rb:/app/static_server.rb
    command: >
      bash -c "
        while true; do
          ruby static_server.rb 9293
          echo 'Static server crashed, restarting in 2 seconds...'
          sleep 2
        done
      "

  api-bridge:
    build:
      context: .
      dockerfile: Dockerfile.dev
    environment:
      - LOG_LEVEL=debug
      - BUNDLE_PATH=/usr/local/bundle
    volumes:
      - .:/app
      - bundle-cache:/usr/local/bundle
    command: >
      bash -c "
        bundle install &&
        while true; do
          ruby api_bridge_server.rb 9294
          echo 'API bridge crashed, restarting in 2 seconds...'
          sleep 2
        done
      "

  # Development database (for future use)
  postgres:
    image: postgres:15-alpine
    container_name: cs2d-postgres
    environment:
      - POSTGRES_USER=cs2d
      - POSTGRES_PASSWORD=development
      - POSTGRES_DB=cs2d_development
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - cs2d-network
    profiles:
      - with-db

  # Redis Commander for Redis GUI
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: cs2d-redis-commander
    environment:
      - REDIS_HOSTS=local:redis:6379
    ports:
      - "8081:8081"
    depends_on:
      - redis
    networks:
      - cs2d-network
    profiles:
      - debug

  # Adminer for database management
  adminer:
    image: adminer
    container_name: cs2d-adminer
    ports:
      - "8080:8080"
    networks:
      - cs2d-network
    profiles:
      - with-db

volumes:
  bundle-cache:
    driver: local
  node-modules:
    driver: local
  postgres-data:
    driver: local