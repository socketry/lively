# Optimized Docker Build Makefile with Layer Caching

.PHONY: build-base build-optimized up-optimized clean-cache stats

# Build base image first (heavy caching here)
build-base:
	@echo "ğŸ”§ Building base image with maximum caching..."
	docker build -f Dockerfile.base -t cs2d_base:latest .
	@echo "âœ… Base image built and cached"

# Build optimized services (fast, using cached base)
build-optimized: build-base
	@echo "âš¡ Building optimized services using cached base..."
	docker-compose -f docker-compose.optimized.yml build
	@echo "âœ… Optimized build complete"

# Test build speed (with cache)
test-cached-build:
	@echo "â±ï¸  Testing cached build speed..."
	time docker-compose -f docker-compose.optimized.yml build --parallel
	@echo "ğŸ“Š Build completed - check time above"

# Start optimized stack
up-optimized: build-optimized
	@echo "ğŸš€ Starting optimized CS2D stack..."
	docker-compose -f docker-compose.optimized.yml up -d
	@echo "âœ… Optimized stack running!"
	@echo "ğŸ“‹ Services:"
	@echo "   Lobby: http://localhost:9292"
	@echo "   Game:  http://localhost:9293" 
	@echo "   API:   http://localhost:9294"

# Show Docker layer cache stats
cache-stats:
	@echo "ğŸ“Š Docker Cache Statistics:"
	docker system df
	@echo "\nğŸ·ï¸  Images:"
	docker images | grep cs2d
	@echo "\nğŸ’¾ Build Cache Detail:"
	docker system df -v | grep -i build

# Clean cache and rebuild (for testing)
clean-cache:
	@echo "ğŸ§¹ Cleaning Docker cache..."
	docker system prune -f
	docker builder prune -f
	@echo "âœ… Cache cleaned"

# Compare build times
benchmark-builds:
	@echo "ğŸƒ Benchmarking build performance..."
	@echo "1ï¸âƒ£ Cold build (no cache):"
	make clean-cache
	time make build-optimized
	@echo "2ï¸âƒ£ Warm build (with cache):"
	time docker-compose -f docker-compose.optimized.yml build
	@echo "ğŸ“ˆ Benchmark complete!"

# Stop optimized services
down-optimized:
	docker-compose -f docker-compose.optimized.yml down -v

# Show optimized logs
logs-optimized:
	docker-compose -f docker-compose.optimized.yml logs -f