# ğŸ¯ CS2D Version 0.2 - Architecture Refactoring Plan

## ğŸ“… ç‰ˆæœ¬è³‡è¨Š

- **ç‰ˆæœ¬è™Ÿ**: 0.2.0-alpha
- **ä»£è™Ÿ**: "Phoenix" (å¾ç°ç‡¼ä¸­é‡ç”Ÿ)
- **è¨ˆåŠƒç™¼å¸ƒ**: 2025å¹´9æœˆ
- **ä¸»é¡Œ**: è§£æ±ºæ¶æ§‹å•é¡Œï¼Œå¯¦ç¾çœŸæ­£çš„çµ±ä¸€æ‡‰ç”¨

## ğŸ”´ ç‰ˆæœ¬ 0.1 ç¾ç‹€è©•ä¼°

### ç•¶å‰å•é¡Œ

1. **ğŸš¨ é—œéµæ¶æ§‹å•é¡Œ**
   - Lively æ¡†æ¶ç„¡é™æ¸²æŸ“å¾ªç’°
   - è¢«è¿«æ¡ç”¨åˆ†æ•£å¼æœå‹™æ¶æ§‹
   - æœå‹™é–“æ•´åˆä¸å®Œæ•´

2. **âš ï¸ æŠ€è¡“å‚µå‹™**
   - å¤šå€‹åŠå®Œæˆçš„æ¶æ§‹å¯¦ç¾ä¸¦å­˜
   - æ²’æœ‰è‡ªå‹•åŒ–æ¸¬è©¦
   - Static server å¥åº·ç‹€æ…‹ä¸ç©©å®š
   - æ–‡æª”èˆ‡å¯¦éš›ä¸ç¬¦

3. **ğŸ“Š ç¾æœ‰å…ƒä»¶ç‹€æ…‹**
   ```
   âœ… é‹è¡Œä¸­ï¼šDocker å®¹å™¨ã€Redisã€å¤§å»³ç³»çµ±
   âš ï¸ ä¸ç©©å®šï¼šéœæ…‹æœå‹™å™¨ã€éŠæˆ²æ•´åˆ
   âŒ ç¼ºå¤±ï¼šæ¸¬è©¦æ¡†æ¶ã€çµ±ä¸€æ¶æ§‹ã€ç›£æ§ç³»çµ±
   ```

## ğŸ¯ ç‰ˆæœ¬ 0.2 æ ¸å¿ƒç›®æ¨™

### 1. **è§£æ±ºç„¡é™æ¸²æŸ“å•é¡Œ** [P0 - æœ€é«˜å„ªå…ˆç´š]

### 2. **å¯¦ç¾çœŸæ­£çš„çµ±ä¸€æ¶æ§‹** [P0]

### 3. **å»ºç«‹æ¸¬è©¦åŸºç¤è¨­æ–½** [P1]

### 4. **æ”¹å–„é–‹ç™¼é«”é©—** [P1]

### 5. **æ€§èƒ½å„ªåŒ–** [P2]

## ğŸ—ï¸ æŠ€è¡“æ¶æ§‹é‡æ§‹æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: **æ··åˆå¼ SPA æ¶æ§‹** (å»ºè­°æ–¹æ¡ˆ)

```mermaid
graph TB
    subgraph "Client Layer"
        C[React/Vue SPA]
        WS[WebSocket Client]
    end

    subgraph "Server Layer"
        L[Lively WebSocket Server]
        API[REST API]
        R[Redis Pub/Sub]
    end

    C <--> WS
    WS <--> L
    C <--> API
    L <--> R
    API <--> R
```

**å¯¦æ–½æ­¥é©Ÿï¼š**

1. å°‡å‰ç«¯å®Œå…¨åˆ†é›¢ç‚ºç¨ç«‹ SPA
2. Lively åƒ…ä½œç‚º WebSocket æœå‹™å™¨
3. ä½¿ç”¨ React/Vue è™•ç†æ‰€æœ‰å®¢æˆ¶ç«¯æ¸²æŸ“
4. REST API è™•ç†éå¯¦æ™‚è«‹æ±‚

### æ–¹æ¡ˆ B: **æ™ºèƒ½æ¸²æŸ“æ§åˆ¶** (ä¿ç•™ Lively)

```ruby
# lib/render_controller.rb
class RenderController
  def initialize(view)
    @view = view
    @render_queue = []
    @rendering = false
    @last_render_time = Time.now
    @min_render_interval = 0.1
  end

  def request_update(priority: :normal)
    return if @rendering

    @render_queue << {
      time: Time.now,
      priority: priority
    }

    process_queue if can_render?
  end

  private

  def can_render?
    Time.now - @last_render_time > @min_render_interval
  end

  def process_queue
    return if @render_queue.empty?

    @rendering = true
    @render_queue.clear

    @view.update!

    @last_render_time = Time.now
    @rendering = false
  end
end
```

### æ–¹æ¡ˆ C: **å¾®å‰ç«¯æ¶æ§‹**

å°‡æ‡‰ç”¨æ‹†åˆ†ç‚ºç¨ç«‹çš„å¾®å‰ç«¯ï¼š

- **Lobby å¾®å‰ç«¯**: å¤§å»³å’Œæˆ¿é–“ç®¡ç†
- **Game å¾®å‰ç«¯**: éŠæˆ²ä¸»é«”
- **Editor å¾®å‰ç«¯**: åœ°åœ–ç·¨è¼¯å™¨
- **Admin å¾®å‰ç«¯**: ç®¡ç†å¾Œå°

## ğŸ“‹ å¯¦æ–½è¨ˆåŠƒ

### ç¬¬ä¸€éšæ®µï¼šåŸºç¤é‡æ§‹ (ç¬¬1-2é€±)

```yaml
ä»»å‹™æ¸…å–®:
  - [ ] å‰µå»ºæ¸²æŸ“æ§åˆ¶å™¨
  - [ ] å¯¦æ–½æ›´æ–°éšŠåˆ—æ©Ÿåˆ¶
  - [ ] æ·»åŠ æ¸²æŸ“é˜²è­·è£ç½®
  - [ ] å»ºç«‹ç‹€æ…‹ç®¡ç†å±¤
  - [ ] å¯¦ç¾äº‹ä»¶ç¯€æµ
```

**å…·é«”ä»£ç¢¼è®Šæ›´ï¼š**

```ruby
# application.rb
require_relative "lib/render_controller"
require_relative "lib/state_manager"

class Application < Lively::Application
  include RenderController
  include StateManager

  configure do
    enable :render_protection
    set :max_render_rate, 10 # æ¯ç§’æœ€å¤š10æ¬¡æ¸²æŸ“
  end
end
```

### ç¬¬äºŒéšæ®µï¼šå‰ç«¯åˆ†é›¢ (ç¬¬3-4é€±)

```yaml
ä»»å‹™æ¸…å–®:
  - [ ] å‰µå»º React/Vue å°ˆæ¡ˆ
  - [ ] å¯¦ç¾å®¢æˆ¶ç«¯è·¯ç”±
  - [ ] å»ºç«‹ WebSocket å®¢æˆ¶ç«¯
  - [ ] ç§»æ¤ç¾æœ‰ UI çµ„ä»¶
  - [ ] å¯¦ç¾ç‹€æ…‹ç®¡ç† (Redux/Vuex)
```

**ç›®éŒ„çµæ§‹ï¼š**

```
cs2d/
â”œâ”€â”€ frontend/               # æ–°å¢å‰ç«¯å°ˆæ¡ˆ
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/   # React/Vue çµ„ä»¶
â”‚   â”‚   â”œâ”€â”€ views/        # é é¢è¦–åœ–
â”‚   â”‚   â”œâ”€â”€ store/        # ç‹€æ…‹ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ services/     # API æœå‹™
â”‚   â”‚   â””â”€â”€ ws/           # WebSocket å®¢æˆ¶ç«¯
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ backend/               # é‡æ§‹å¾Œç«¯
â”‚   â”œâ”€â”€ lively_ws.rb      # WebSocket æœå‹™
â”‚   â”œâ”€â”€ api_server.rb     # REST API
â”‚   â””â”€â”€ game_engine.rb    # éŠæˆ²é‚è¼¯
â””â”€â”€ shared/                # å…±äº«ä»£ç¢¼
    â””â”€â”€ protocols/         # é€šè¨Šå”è­°å®šç¾©
```

### ç¬¬ä¸‰éšæ®µï¼šæ¸¬è©¦åŸºç¤è¨­æ–½ (ç¬¬5é€±)

```yaml
ä»»å‹™æ¸…å–®:
  - [ ] è¨­ç½® RSpec
  - [ ] è¨­ç½® Playwright
  - [ ] å‰µå»º CI/CD pipeline
  - [ ] ç·¨å¯«å–®å…ƒæ¸¬è©¦
  - [ ] ç·¨å¯«é›†æˆæ¸¬è©¦
```

**æ¸¬è©¦è¦†è“‹ç›®æ¨™ï¼š**

- å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡ > 70%
- é—œéµè·¯å¾‘é›†æˆæ¸¬è©¦ 100%
- E2E æ¸¬è©¦ä¸»è¦ç”¨æˆ¶æµç¨‹

### ç¬¬å››éšæ®µï¼šæ€§èƒ½å„ªåŒ– (ç¬¬6é€±)

```yaml
ä»»å‹™æ¸…å–®:
  - [ ] å¯¦ç¾ WebSocket é€£æ¥æ± 
  - [ ] å„ªåŒ– Redis æŸ¥è©¢
  - [ ] æ·»åŠ å®¢æˆ¶ç«¯ç·©å­˜
  - [ ] å¯¦ç¾è³‡æºæ‡¶åŠ è¼‰
  - [ ] æ·»åŠ  CDN æ”¯æŒ
```

## ğŸ”§ æŠ€è¡“æ£§å‡ç´š

### å‰ç«¯æŠ€è¡“æ£§

```json
{
  "framework": "React 18 / Vue 3",
  "state": "Redux Toolkit / Pinia",
  "ui": "Tailwind CSS + Headless UI",
  "bundler": "Vite",
  "testing": "Vitest + Playwright",
  "websocket": "Socket.io-client"
}
```

### å¾Œç«¯å„ªåŒ–

```ruby
# Gemfile æ›´æ–°
gem 'lively', '~> 0.6'           # å‡ç´šåˆ°æœ€æ–°ç‰ˆ
gem 'redis', '~> 5.0'            # Redis å®¢æˆ¶ç«¯
gem 'rack-cors'                  # CORS æ”¯æŒ
gem 'oj'                         # å¿«é€Ÿ JSON è§£æ
gem 'concurrent-ruby'            # ä¸¦ç™¼å·¥å…·
gem 'dry-validation'             # æ•¸æ“šé©—è­‰

# é–‹ç™¼/æ¸¬è©¦
group :development, :test do
  gem 'rspec'
  gem 'factory_bot'
  gem 'faker'
  gem 'simplecov'
  gem 'rubocop'
end
```

## ğŸ“Š æ€§èƒ½ç›®æ¨™

| æŒ‡æ¨™               | ç•¶å‰ (v0.1) | ç›®æ¨™ (v0.2) | æ”¹å–„  |
| ------------------ | ----------- | ----------- | ----- |
| **é¦–æ¬¡åŠ è¼‰æ™‚é–“**   | ~3s         | <1s         | -66%  |
| **WebSocket å»¶é²** | ~100ms      | <50ms       | -50%  |
| **æ¸²æŸ“å¾ªç’°**       | ç„¡é™/å´©æ½°   | 0           | 100%  |
| **å…§å­˜ä½¿ç”¨**       | ~200MB      | <150MB      | -25%  |
| **ä¸¦ç™¼ç©å®¶**       | 50          | 200+        | +300% |
| **æ¸¬è©¦è¦†è“‹ç‡**     | 0%          | 70%+        | +70%  |

## ğŸš€ ç™¼å¸ƒè¨ˆåŠƒ

### Alpha éšæ®µ (ç¬¬1-4é€±)

- å…§éƒ¨æ¸¬è©¦
- æ ¸å¿ƒåŠŸèƒ½é©—è­‰
- æ€§èƒ½åŸºæº–æ¸¬è©¦

### Beta éšæ®µ (ç¬¬5-6é€±)

- å…¬é–‹æ¸¬è©¦
- æ”¶é›†åé¥‹
- Bug ä¿®å¾©

### Release Candidate (ç¬¬7é€±)

- æœ€çµ‚æ¸¬è©¦
- æ–‡æª”æ›´æ–°
- éƒ¨ç½²æº–å‚™

### æ­£å¼ç™¼å¸ƒ (ç¬¬8é€±)

- v0.2.0 æ­£å¼ç™¼å¸ƒ
- é·ç§»æŒ‡å—
- å…¬å‘Šå’Œæ¨å»£

## ğŸ’¡ å‰µæ–°åŠŸèƒ½ (v0.2 æ–°å¢)

1. **å¯¦æ™‚å”ä½œåœ°åœ–ç·¨è¼¯å™¨**
   - å¤šäººåŒæ™‚ç·¨è¼¯
   - ç‰ˆæœ¬æ§åˆ¶
   - å¯¦æ™‚é è¦½

2. **AI å°æ‰‹ç³»çµ±**
   - æ™ºèƒ½è·¯å¾‘è¦åŠƒ
   - æˆ°è¡“æ±ºç­–
   - é›£åº¦è‡ªé©æ‡‰

3. **è§€æˆ°æ¨¡å¼**
   - å¯¦æ™‚è§€æˆ°
   - éŒ„åƒå›æ”¾
   - ç²¾å½©æ™‚åˆ»

4. **çµ±è¨ˆåˆ†æå„€è¡¨æ¿**
   - ç©å®¶çµ±è¨ˆ
   - éŠæˆ²åˆ†æ
   - æ€§èƒ½ç›£æ§

## ğŸ¯ æˆåŠŸæ¨™æº–

âœ… **å¿…é ˆé”æˆï¼š**

- å®Œå…¨è§£æ±ºç„¡é™æ¸²æŸ“å•é¡Œ
- çµ±ä¸€æ¶æ§‹å¯¦ç¾
- åŸºæœ¬æ¸¬è©¦è¦†è“‹
- æ–‡æª”èˆ‡ä»£ç¢¼ä¸€è‡´

âœ… **æ‡‰è©²é”æˆï¼š**

- æ€§èƒ½æå‡ 50%
- é–‹ç™¼é«”é©—æ”¹å–„
- CI/CD è‡ªå‹•åŒ–
- ç›£æ§ç³»çµ±å°±ä½

âœ… **æœ€å¥½é”æˆï¼š**

- å¾®å‰ç«¯æ¶æ§‹
- AI ç³»çµ±
- è§€æˆ°åŠŸèƒ½
- 200+ ä¸¦ç™¼æ”¯æŒ

## ğŸ“ é¢¨éšªç®¡ç†

| é¢¨éšª                    | å¯èƒ½æ€§ | å½±éŸ¿ | ç·©è§£æªæ–½         |
| ----------------------- | ------ | ---- | ---------------- |
| Lively æ¡†æ¶é™åˆ¶ç„¡æ³•å…‹æœ | ä¸­     | é«˜   | æº–å‚™å®Œå…¨æ›¿æ›æ–¹æ¡ˆ |
| å‰ç«¯é‡å¯«å·¥ä½œé‡è¶…é æœŸ    | é«˜     | ä¸­   | åˆ†éšæ®µé·ç§»       |
| æ€§èƒ½ç›®æ¨™æœªé”æˆ          | ä½     | ä¸­   | æå‰æ€§èƒ½æ¸¬è©¦     |
| ç”¨æˆ¶é·ç§»å›°é›£            | ä¸­     | ä½   | æä¾›é·ç§»å·¥å…·     |

## ğŸ”„ è¿­ä»£è¨ˆåŠƒ

```mermaid
gantt
    title CS2D v0.2 é–‹ç™¼æ™‚é–“ç·š
    dateFormat  YYYY-MM-DD
    section åŸºç¤é‡æ§‹
    æ¸²æŸ“æ§åˆ¶å™¨           :a1, 2025-09-01, 7d
    ç‹€æ…‹ç®¡ç†å±¤           :a2, after a1, 7d
    section å‰ç«¯åˆ†é›¢
    React/Vue å°ˆæ¡ˆ       :b1, 2025-09-15, 7d
    çµ„ä»¶ç§»æ¤            :b2, after b1, 7d
    section æ¸¬è©¦
    æ¸¬è©¦æ¡†æ¶            :c1, 2025-09-29, 5d
    æ¸¬è©¦ç·¨å¯«            :c2, after c1, 5d
    section å„ªåŒ–
    æ€§èƒ½å„ªåŒ–            :d1, 2025-10-06, 7d
    section ç™¼å¸ƒ
    Beta æ¸¬è©¦           :e1, 2025-10-13, 7d
    æ­£å¼ç™¼å¸ƒ            :e2, 2025-10-20, 1d
```

## ğŸ“š åƒè€ƒè³‡æ–™

- [Lively Framework Issues](https://github.com/socketry/lively/issues)
- [React Server Components](https://react.dev/blog/2023/03/22/react-labs-what-we-have-been-working-on-march-2023)
- [WebSocket Best Practices](https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API)
- [å¾®å‰ç«¯æ¶æ§‹æŒ‡å—](https://micro-frontends.org/)

## ğŸ¤ åœ˜éšŠåˆ†å·¥

| è§’è‰²       | è·è²¬               | é è¨ˆå·¥æ™‚ |
| ---------- | ------------------ | -------- |
| æ¶æ§‹å¸«     | ç³»çµ±è¨­è¨ˆã€æŠ€è¡“æ±ºç­– | 20%      |
| å‰ç«¯é–‹ç™¼   | React/Vue å¯¦ç¾     | 40%      |
| å¾Œç«¯é–‹ç™¼   | Lively é‡æ§‹ã€API   | 30%      |
| æ¸¬è©¦å·¥ç¨‹å¸« | æ¸¬è©¦æ¡†æ¶ã€è‡ªå‹•åŒ–   | 10%      |

---

## âœ… è¡Œå‹•é …ç›®

### ç«‹å³è¡Œå‹• (æœ¬é€±)

1. [ ] å‰µå»ºæ¸²æŸ“æ§åˆ¶å™¨åŸå‹
2. [ ] è©•ä¼°å‰ç«¯æ¡†æ¶é¸æ“‡
3. [ ] è¨­ç½®é–‹ç™¼åˆ†æ”¯
4. [ ] æ›´æ–°åœ˜éšŠæ–‡æª”

### çŸ­æœŸç›®æ¨™ (2é€±å…§)

1. [ ] å®ŒæˆåŸºç¤é‡æ§‹
2. [ ] å•Ÿå‹•å‰ç«¯å°ˆæ¡ˆ
3. [ ] å»ºç«‹ CI/CD
4. [ ] ç¬¬ä¸€æ¬¡æ€§èƒ½æ¸¬è©¦

### ä¸­æœŸç›®æ¨™ (1å€‹æœˆ)

1. [ ] Beta ç‰ˆæœ¬å°±ç·’
2. [ ] æ¸¬è©¦è¦†è“‹ > 50%
3. [ ] æ€§èƒ½é”æ¨™
4. [ ] æ–‡æª”å®Œæ•´

---

_ç‰ˆæœ¬è¨ˆåŠƒåˆ¶å®šæ—¥æœŸï¼š2025å¹´8æœˆ16æ—¥_
_è² è²¬äººï¼šCS2D é–‹ç™¼åœ˜éšŠ_
_ç‹€æ…‹ï¼šå¾…å¯©æ ¸_

**ä¸‹ä¸€æ­¥ï¼šåœ˜éšŠè©•å¯©æ­¤è¨ˆåŠƒä¸¦ç¢ºå®šå¯¦æ–½å„ªå…ˆç´š**
